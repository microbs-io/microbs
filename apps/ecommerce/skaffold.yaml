apiVersion: skaffold/v2beta27
kind: Config
build:
  tagPolicy:
    customTemplate:
      template: "{{.GIT_COMMIT}}-{{.VARIANT}}"
      components:
      - name: GIT_COMMIT
        gitCommit: {}
      - name: VARIANT
        envTemplate:
          template: "{{.VARIANT}}"


####  Main  ####################################################################

profiles:
- name: main
  build:
    artifacts:
    - image: microbs-ecommerce-api-gateway
      context: ./apps/ecommerce
      docker:
        dockerfile: services/api-gateway/Dockerfile
    - image: microbs-ecommerce-cart
      context: ./apps/ecommerce
      docker:
        dockerfile: services/cart/Dockerfile
    - image: microbs-ecommerce-checkout
      context: ./apps/ecommerce
      docker:
        dockerfile: services/checkout/Dockerfile
    - image: microbs-ecommerce-cart-data
      context: ./apps/ecommerce
      docker:
        dockerfile: services/cart-data/Dockerfile
    - image: microbs-ecommerce-content
      context: ./apps/ecommerce
      docker:
        dockerfile: services/content/Dockerfile
    - image: microbs-ecommerce-payment
      context: ./apps/ecommerce
      docker:
        dockerfile: services/payment/Dockerfile
    - image: microbs-ecommerce-product
      context: ./apps/ecommerce
      docker:
        dockerfile: services/product/Dockerfile
    - image: microbs-ecommerce-product-data
      context: ./apps/ecommerce
      docker:
        dockerfile: services/product-data/Dockerfile
    - image: microbs-ecommerce-session-data
      context: ./apps/ecommerce
      docker:
        dockerfile: services/session-data/Dockerfile
    - image: microbs-ecommerce-synthetics
      context: ./apps/ecommerce
      docker:
        dockerfile: services/synthetics/Dockerfile
    - image: microbs-ecommerce-web-gateway
      context: ./apps/ecommerce
      docker:
        dockerfile: services/web-gateway/Dockerfile
  deploy:
    kubectl:
      manifests:
      - ./apps/ecommerce/services/*/k8s/*.yaml


####  Variants  ################################################################

- name: basic-bug
  build:
    artifacts:
    - image: microbs-ecommerce-product
      context: ./apps/ecommerce
      docker:
        dockerfile: variants/basic-bug/product/Dockerfile
  deploy:
    kubectl:
      manifests:
      - ./apps/ecommerce/variants/basic-bug/*/k8s/*.yaml

- name: traffic-spike
  deploy:
    kubectl:
      manifests:
      - ./apps/ecommerce/variants/traffic-spike/*/k8s/*.yaml
