# Build ./public
FROM node:17 AS build-react
WORKDIR /service
COPY ./services/web-gateway/src/public ./src/public
COPY ./services/web-gateway/package.json .

ARG DEPLOYMENT_ENVIRONMENT
ARG SERVICE_NAME
ARG SERVICE_BIND_HOST
ARG SERVICE_BIND_PORT
ARG OTEL_RESOURCE_ATTRIBUTES
ARG OTLP_RECEIVER_HOST
ARG OTLP_RECEIVER_PORT
ENV DEPLOYMENT_ENVIRONMENT=${DEPLOYMENT_ENVIRONMENT}
ENV SERVICE_NAME=${SERVICE_NAME}
ENV SERVICE_BIND_HOST=${SERVICE_BIND_HOST}
ENV SERVICE_BIND_PORT=${SERVICE_BIND_PORT}
ENV OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
ENV OTLP_RECEIVER_HOST=${OTLP_RECEIVER_HOST}
ENV OTLP_RECEIVER_PORT=${OTLP_RECEIVER_PORT}

RUN yarn install
RUN yarn run build

# Build ./server
FROM python:3.8-slim
WORKDIR /service

# Requirements for service
COPY ./services/web-gateway/src/server ./src
COPY ./services/web-gateway/requirements.txt .
COPY ./common/python ./src
RUN pip install -r ./requirements.txt

COPY --from=build-react /service/dist /service/dist

# Configuration inputs
ARG DEPLOYMENT_ENVIRONMENT
ARG SERVICE_NAME
ARG SERVICE_BIND_HOST
ARG SERVICE_BIND_PORT
ARG SERVICE_HOST_API_GATEWAY
ARG SERVICE_PORT_API_GATEWAY
ARG SERVICE_HOST_SESSION_DATA
ARG SERVICE_PORT_SESSION_DATA
ARG OTLP_RECEIVER_HOST
ARG OTLP_RECEIVER_PORT
ENV DEPLOYMENT_ENVIRONMENT=${DEPLOYMENT_ENVIRONMENT}
ENV SERVICE_NAME=${SERVICE_NAME}
ENV SERVICE_BIND_HOST=${SERVICE_BIND_HOST}
ENV SERVICE_BIND_PORT=${SERVICE_BIND_PORT}
ENV SERVICE_HOST_API_GATEWAY=${SERVICE_HOST_API_GATEWAY}
ENV SERVICE_PORT_API_GATEWAY=${SERVICE_PORT_API_GATEWAY}
ENV SERVICE_HOST_SESSION_DATA=${SERVICE_HOST_SESSION_DATA}
ENV SERVICE_HOST_SESSION_DATA=${SERVICE_HOST_SESSION_DATA}
ENV OTLP_RECEIVER_HOST=${OTLP_RECEIVER_HOST}
ENV OTLP_RECEIVER_PORT=${OTLP_RECEIVER_PORT}

ENTRYPOINT [ "gunicorn", "--chdir", "src", "server:app", "-w", "2", "--threads", "2", "-b", "0.0.0.0:80", "-c", "./src/gunicorn.py" ]
EXPOSE ${SERVICE_BIND_PORT}
