FROM python:3.9-slim
WORKDIR /service

# Requirements for service
COPY ./services/api-gateway .
COPY ./common/python ./src
RUN pip install -r ./requirements.txt

# Configuration inputs
ARG DEPLOYMENT_ENVIRONMENT
ARG SERVICE_NAME
ARG SERVICE_BIND_HOST
ARG SERVICE_BIND_PORT
ARG SERVICE_VERSION
ARG OTEL_RESOURCE_ATTRIBUTES
ARG OTLP_RECEIVER_HOST
ARG OTLP_RECEIVER_PORT
ENV DEPLOYMENT_ENVIRONMENT=${DEPLOYMENT_ENVIRONMENT:-development}
ENV SERVICE_NAME=${SERVICE_NAME:-service}
ENV SERVICE_BIND_HOST=${SERVICE_BIND_HOST:-0.0.0.0}
ENV SERVICE_BIND_PORT=${SERVICE_BIND_PORT:-80}
ENV SERVICE_VERSION=${SERVICE_VERSION}
ENV OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
ENV OTLP_RECEIVER_HOST=${OTLP_RECEIVER_HOST:-localhost}
ENV OTLP_RECEIVER_PORT=${OTLP_RECEIVER_PORT:-4317}

ENTRYPOINT gunicorn --chdir src server:app -b ${SERVICE_BIND_HOST}:${SERVICE_BIND_PORT} -c ./src/gunicorn.py --worker-connections 1024 -k gevent
EXPOSE ${SERVICE_BIND_PORT}
